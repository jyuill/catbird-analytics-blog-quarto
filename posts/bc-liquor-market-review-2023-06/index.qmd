---
title: "BC Liquor Market Review - Jun 2023 edition"
author: John Yuill
date: '2023-11-05'
categories: [lmr, reporting, analysis]
description-meta: Analysis of BC Liquor Market Review covering period to June 2023, with trends and observations.
draft: true
#image: 
toc: true
toc-depth: 4
toc-location: left
date-modified: '`r Sys.Date()`'
fig-height: 4
fig-width: 6
execute:
  echo: true
  error: false
  warning: false
---

```{r}
#| echo: FALSE
#| warning: FALSE
library(tidyverse)
library(lubridate)
library(scales)
library(glue)
library(ggrepel)
library(readr) ## for easy conversion of $ characters to numeric
library(RMariaDB) ## best way to access MySQL from R
library(RColorBrewer)
library(here)
# set default theme
theme_set(theme_classic())

# chart parameters
# check rcolorbrewer palette
#display.brewer.pal(n=8, name='Set2')
#display.brewer.pal(n=8, name='Dark2')
##display.brewer.pal(n=9, name='YlOrRd')
#display.brewer.pal(n=9, name='YlGnBu')
bar_col <- brewer.pal(n=9, name='YlGnBu')[9]
# set colors for major category types
#bpal <- brewer.pal(n=8, name='Dark2')
#cat_type_color <- c("Beer"=bpal[6], "Refresh Bev"=bpal[5], "Spirits"=bpal[7], "Wine"=bpal[4])
bpal <- brewer.pal(n=9, name="YlOrRd")
cat_type_color <- c("Beer"=bpal[6], "Refresh Bev"=bpal[3], "Spirits"=bpal[4], "Wine"=bpal[8])

```

```{r get_process_data}
#| echo: FALSE
# if no data available - fetch
if(exists('lmr_data')){
  lmr_data <- lmr_data
} else { # get from MySQL database on AWS
    source(here('credo.R'))
    # local server
    #con <- dbConnect(RMariaDB::MariaDB(), user='root', password=mypwd, dbname='bcbg')
    # aws
    con_aws <- dbConnect(RMariaDB::MariaDB(),
                       host=endpt,
                       user='admin',
                       password=apwd,
                       port=aport)
    lmr_data <- dbGetQuery(con_aws, "SELECT * FROM bcbg.tblLDB_lmr lmr
                           LEFT JOIN bcbg.tblLDB_quarter qtr ON lmr.fy_qtr=qtr.fy_qtr;")
    dbDisconnect(con_aws)
    # clean-up
    lmr_data <- lmr_data %>% select(-fy_qtr..8)
    lmr_data <- lmr_data %>% mutate(
      cat_type = ifelse(cat_type=='Refreshment Beverages','Refresh Bev',cat_type)
    )
    lmr_data <- lmr_data %>% mutate(
      start_qtr_dt =floor_date(end_qtr_dt, unit="months")
    )
    lmr_data$netsales <- as.numeric(lmr_data$netsales)
    lmr_data$litres <- as.numeric(lmr_data$litres)
}
```

## BC Liquor Market Review - up to June 2023

**BC Liquor Distribution Board** releases its '**Liquor Market Review**' of market statistics on a quarterly basis. The reports are made available to the public through [BC LDB website](https://www.bcldb.com/publications/liquor-market-review).

This is a combined look at quarterly data going back as long as the current format has been published: 2015.

Notes on 'net \$ sales':

-   the report says "**Net dollar value is based on the price paid by the customer** and excludes any applicable taxes."
-   calculating average **net dollar value per litre for beverage categories gives unrealistically low numbers** compared to retail prices in BC liquor stores. (*Beer at average \$4/litre? Not even the cheapest beer on the [BC Liquor Stores](https://www.bcliquorstores.com/product-catalogue?category=beer&sort=currentPrice:desc&page=1) website.*)
-   there is likely additional factors related to BC LDB pricing structure, wholesaling, etc.
-   best to **consider average net dollar value per litre referred to below as relative indicator**.

## TREND OVERVIEW

### Annual: All Categories

#### \$ Sales

What are the annual trends in total sales in recent years? (based on most recent full yr avail.)

```{r, calc_YoY}
# get full years for comparison
drop_yr <- c(2015,2023) ## drop partial yrs for simplicity
trend_yr <- lmr_data %>% filter(cyr>drop_yr[1] & cyr<drop_yr[2]) %>% 
  group_by(cyr) %>% summarize(netsales=sum(netsales),
                              litres=sum(litres))

# add % chg YoY, $/l
trend_yr <- trend_yr %>% mutate(
  pc_chg_sales=netsales/lag(netsales)-1,
  pc_chg_litres=litres/lag(litres)-1,
  dollar_per_litre=netsales/litres,
  pc_chg_d_per_l=dollar_per_litre/lag(dollar_per_litre)-1
)

```

```{r}
ch_title <- "Net Sales $ Trends - All Categories"
trend_yr %>% ggplot(aes(x=as.factor(cyr), y=netsales, group=1))+
  geom_line(color=bar_col, size=2)+
  geom_point(aes(y=netsales), color=bar_col, size=3)+
  scale_y_continuous(labels=comma_format(prefix="$", scale=1e-9,suffix="B"), expand=expansion(mult=c(0,0.1)), limits=c(0,max(trend_yr$netsales)))+
  labs(title=ch_title,y="",x="")+
  theme_classic()+
  theme(axis.ticks.x = element_blank()) 
```
